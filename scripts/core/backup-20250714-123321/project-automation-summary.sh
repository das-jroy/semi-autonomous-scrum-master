#!/bin/bash

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/config-helper.sh"

# Load project configuration
load_config


# Project Automation Summary
# Comprehensive overview of all completed automation work

set -e

echo "üéØ $PROJECT_NAME Project Automation Summary"
echo "=============================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Configuration
# REPO_OWNER loaded from config
PROJECT_NUMBER="3"
PROJECT_URL="https://github.com/orgs/$REPO_OWNER/projects/$PROJECT_NUMBER"

# Function to show project overview
show_project_overview() {
    echo -e "${BOLD}${CYAN}üìã Project Overview${NC}"
    echo "=================="
    
    local project_info=$(gh api graphql -f query='
    query($projectNumber: Int!, $owner: String!) {
      organization(login: $owner) {
        projectV2(number: $projectNumber) {
          title
          url
          items {
            totalCount
          }
          fields(first: 20) {
            nodes {
              ... on ProjectV2SingleSelectField {
                name
                options {
                  name
                }
              }
            }
          }
        }
      }
    }' -f projectNumber="$PROJECT_NUMBER" -f owner="$REPO_OWNER")
    
    local title=$(echo "$project_info" | jq -r '.data.organization.projectV2.title')
    local total_items=$(echo "$project_info" | jq -r '.data.organization.projectV2.items.totalCount')
    
    echo "Project: $title"
    echo "URL: $PROJECT_URL"
    echo "Total Issues: $total_items"
    echo ""
}

# Function to show completed automation
show_completed_automation() {
    echo -e "${BOLD}${GREEN}‚úÖ Completed Automation${NC}"
    echo "======================"
    echo ""
    
    echo -e "${GREEN}üéØ Core TODO & Issue Management:${NC}"
    echo "   ‚úÖ Created secure-github-issues.sh - Safe issue creation"
    echo "   ‚úÖ Generated 17 structured GitHub issues from TODOs"
    echo "   ‚úÖ Added all issues to project board"
    echo "   ‚úÖ Applied full metadata (labels, priority, complexity, etc.)"
    echo ""
    
    echo -e "${GREEN}üìä Project Board Automation:${NC}"
    echo "   ‚úÖ Created custom fields (Priority, Module Category, Complexity)"
    echo "   ‚úÖ Added security review field for compliance tracking"
    echo "   ‚úÖ Created 5 recommended project views"
    echo "   ‚úÖ Set up automated field population"
    echo ""
    
    echo -e "${GREEN}üîß Development Workflow:${NC}"
    echo "   ‚úÖ Merged module-scaffold PR after fixing CI/CD issues"
    echo "   ‚úÖ Enhanced all module documentation"
    echo "   ‚úÖ Created comprehensive setup guides"
    echo "   ‚úÖ Validated all module completion status"
    echo ""
    
    echo -e "${GREEN}üìù Scripts & Documentation:${NC}"
    echo "   ‚úÖ Created 15+ automation scripts"
    echo "   ‚úÖ Added PROJECT-SETUP-GUIDE.md"
    echo "   ‚úÖ Enhanced CONTRIBUTING.md"
    echo "   ‚úÖ Updated all module READMEs"
    echo ""
}

# Function to show available scripts
show_available_scripts() {
    echo -e "${BOLD}${BLUE}üõ†Ô∏è  Available Automation Scripts${NC}"
    echo "================================"
    echo ""
    
    echo -e "${CYAN}Core Management:${NC}"
    echo "   üìù secure-github-issues.sh - Create GitHub issues from TODOs"
    echo "   üîß update-issues-metadata.sh - Add labels and metadata to issues"
    echo "   ‚úÖ add-issues-to-project.sh - Add issues to project board"
    echo ""
    
    echo -e "${CYAN}Project Board Setup:${NC}"
    echo "   üéõÔ∏è  final-project-setup.sh - Complete project board configuration"
    echo "   üëÅÔ∏è  create-project-views.sh - Create recommended views"
    echo "   üìä verify-kanban-status.sh - Check current workflow status"
    echo ""
    
    echo -e "${CYAN}Kanban Enhancement:${NC}"
    echo "   üöÄ complete-kanban-automation.sh - Enhance workflow with Review/Blocked"
    echo "   üåê browser-console-kanban-enhancement.js - Browser automation"
    echo "   üìã manual-kanban-enhancement.md - Manual setup guide"
    echo ""
    
    echo -e "${CYAN}Module Development:${NC}"
    echo "   üèóÔ∏è  scaffold-remaining-modules.sh - Create module scaffolds"
    echo "   ‚úÖ validate-modules.sh - Check module completion"
    echo "   üîç test-modules.sh - Run module tests"
    echo ""
}

# Function to show current status
show_current_status() {
    echo -e "${BOLD}${YELLOW}üìà Current Project Status${NC}"
    echo "========================="
    echo ""
    
    # Count modules by status
    local complete_modules=0
    local incomplete_modules=0
    
    for module_dir in modules/*/; do
        if [[ -d "$module_dir" ]]; then
            module_name=$(basename "$module_dir")
            
            # Check if module has TODOs (indicates incomplete)
            if find "$module_dir" -name "*.tf" -o -name "*.md" | xargs grep -l "TODO" 2>/dev/null >/dev/null; then
                ((incomplete_modules++))
            else
                ((complete_modules++))
            fi
        fi
    done
    
    echo -e "${GREEN}‚úÖ Complete Modules: $complete_modules${NC}"
    echo -e "${YELLOW}üîß Modules Needing Work: $incomplete_modules${NC}"
    echo -e "${BLUE}üìã Total GitHub Issues: 17${NC}"
    echo ""
    
    # Check kanban status
    local field_info=$(gh api graphql -f query='
    query($projectNumber: Int!, $owner: String!) {
      organization(login: $owner) {
        projectV2(number: $projectNumber) {
          fields(first: 20) {
            nodes {
              ... on ProjectV2SingleSelectField {
                name
                options {
                  name
                }
              }
            }
          }
        }
      }
    }' -f projectNumber="$PROJECT_NUMBER" -f owner="$REPO_OWNER" 2>/dev/null)
    
    local has_review=$(echo "$field_info" | jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "Review") | .name // empty' 2>/dev/null)
    local has_blocked=$(echo "$field_info" | jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "Blocked") | .name // empty' 2>/dev/null)
    
    if [[ -n "$has_review" && -n "$has_blocked" ]]; then
        echo -e "${GREEN}üéØ Kanban Workflow: Enhanced (Review + Blocked statuses)${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Kanban Workflow: Basic (Todo ‚Üí In Progress ‚Üí Done)${NC}"
        echo -e "${CYAN}   üí° Run: ./scripts/complete-kanban-automation.sh to enhance${NC}"
    fi
    
    echo ""
}

# Function to show next steps
show_next_steps() {
    echo -e "${BOLD}${PURPLE}üöÄ Next Steps${NC}"
    echo "============="
    echo ""
    
    echo -e "${CYAN}1. Enhance Kanban Workflow (Optional):${NC}"
    echo "   ‚Ä¢ Run: ./scripts/complete-kanban-automation.sh"
    echo "   ‚Ä¢ Or manually add 'Review' and 'Blocked' status columns"
    echo "   ‚Ä¢ Create Sprint Board view grouped by Status"
    echo ""
    
    echo -e "${CYAN}2. Start Module Implementation:${NC}"
    echo "   ‚Ä¢ Visit: $PROJECT_URL"
    echo "   ‚Ä¢ Pick high-priority issues from the backlog"
    echo "   ‚Ä¢ Move issues through the workflow as you progress"
    echo "   ‚Ä¢ Create pull requests and link to issues"
    echo ""
    
    echo -e "${CYAN}3. Use the Automation:${NC}"
    echo "   ‚Ä¢ Run scripts as needed for ongoing maintenance"
    echo "   ‚Ä¢ Update issue metadata using update-issues-metadata.sh"
    echo "   ‚Ä¢ Monitor progress with verify-kanban-status.sh"
    echo ""
    
    echo -e "${CYAN}4. Team Development:${NC}"
    echo "   ‚Ä¢ Assign issues to team members"
    echo "   ‚Ä¢ Use project board for sprint planning"
    echo "   ‚Ä¢ Track progress and blockers visually"
    echo ""
}

# Function to show resources
show_resources() {
    echo -e "${BOLD}${BLUE}üìö Resources & Documentation${NC}"
    echo "============================"
    echo ""
    
    echo -e "${GREEN}Project Links:${NC}"
    echo "   ‚Ä¢ Project Board: $PROJECT_URL"
    echo "   ‚Ä¢ Repository: https://github.com/$REPO_OWNER/$REPO_NAME"
    echo "   ‚Ä¢ Issues: https://github.com/$REPO_OWNER/$REPO_NAME/issues"
    echo ""
    
    echo -e "${GREEN}Key Documentation:${NC}"
    echo "   ‚Ä¢ PROJECT-SETUP-GUIDE.md - Complete setup instructions"
    echo "   ‚Ä¢ CONTRIBUTING.md - Development guidelines"
    echo "   ‚Ä¢ README.md - Project overview"
    echo "   ‚Ä¢ docs/index.md - Module documentation"
    echo ""
    
    echo -e "${GREEN}Automation Files:${NC}"
    echo "   ‚Ä¢ scripts/ - All automation scripts"
    echo "   ‚Ä¢ manual-kanban-enhancement.md - Manual setup guide"
    echo "   ‚Ä¢ browser-console-kanban-enhancement.js - Browser automation"
    echo ""
}

# Function to show help
show_help() {
    echo "Usage: $0 [--overview|--scripts|--status|--help]"
    echo ""
    echo "Options:"
    echo "  --overview    Show project overview only"
    echo "  --scripts     Show available scripts only"
    echo "  --status      Show current status only"
    echo "  --help        Show this help"
    echo ""
    echo "Examples:"
    echo "  $0                    # Show complete summary"
    echo "  $0 --status          # Check current project status"
    echo "  $0 --scripts         # List available automation scripts"
}

# Main execution
main() {
    if ! command -v gh &> /dev/null; then
        echo -e "${RED}‚ùå GitHub CLI not installed${NC}"
        echo "Please install GitHub CLI to use this summary script."
        exit 1
    fi
    
    show_project_overview
    show_completed_automation
    show_available_scripts
    show_current_status
    show_next_steps
    show_resources
    
    echo -e "${BOLD}${GREEN}üéâ Project Automation Complete!${NC}"
    echo ""
    echo -e "${YELLOW}The $PROJECT_NAME project is now fully automated with:${NC}"
    echo "‚Ä¢ ‚úÖ 17 structured GitHub issues"
    echo "‚Ä¢ üìä Enhanced project board with custom fields"
    echo "‚Ä¢ üéØ Comprehensive kanban workflow (ready for enhancement)"
    echo "‚Ä¢ üõ†Ô∏è  15+ automation scripts for ongoing management"
    echo "‚Ä¢ üìö Complete documentation and setup guides"
    echo ""
    echo -e "${CYAN}Start developing by visiting: $PROJECT_URL${NC}"
}

# Command line options
case "${1:-}" in
    --overview)
        show_project_overview
        ;;
    --scripts)
        show_available_scripts
        ;;
    --status)
        show_current_status
        ;;
    --help)
        show_help
        ;;
    *)
        main
        ;;
esac
